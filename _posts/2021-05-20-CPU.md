---
layout: post
title:  "MIPS Pipeline CPU"
info: "Design and Implementation of a Pipeline CPU based on MIPS architecture"
tech : "Verilog"
type: Project
---
<h2><center>Design and Implementation of a Pipeline CPU based on MIPS architecture</center></h2>

Click here to see the [code](https://github.com/mtzhang1999/Pipeline-CPU).

This project is based on my [multi-cycle CPU](https://github.com/mtzhang1999/Pipeline-CPU/tree/main/multi-cycle%20CPU) project.

## Intro to the multi-cycle CPU

The FSM is designed for different instructions. The IF and ID stages of all instructions are the same. The OpCode and Funct of different instructions jointly determine the subsequent state jumps.

The status and control signals of different instructions in the IF and ID phases are the same, and the subsequent status will shift to a different state according to the corresponding instructions.

The number of clock cycles required to complete the execution of each instruction is also inconsistent. All instructions are transferred to the initial IF stage after the execution is completed, forming a closed loop.

The specific FSM design and transition are shown in the figure below:

![cpu-1](\imgs\Projects\cpu-1.png)

And the data path is shown in the figure below:

![cpu-2](\imgs\Projects\cpu-2.jpg)

The multi-cycle CPU support the following instructions:

```
lw, sw, lui,
add, addu, sub, subu, addi, addiu,
and, or, xor, nor, andi, sll, srl, sra, slt, sltu, sltiu,
beq, j, jal, jr, jalr
```

## Pipeline CPU

### Solution to the Race condition

- Use a complete forwarding circuit to solve the data association problem;
- For Load-use competition, the method of blocking one cycle + forwarding is adopted to solve it;
- For branch instructions to be judged in the EX stage, cancel the two instructions in the ID and IF stages when the branch occurs;
- For J instructions, judge in the ID stage and cancel the IF stage instructions;

### Implementation of 5-stage pipeline

IF stage: In the IF stage, the processor reads the instructions in the instruction register according to the value of the PC and updates the PC;

ID stage: According to the OpCode of the instruction, the processor interprets the subsequent control signals, the address of the read and write register, and the immediate data used for calculation, and reads the register as needed. At the same time, it needs to generate control signals such as forwarding and interrupt;

EX stage: According to the requirements of the OpCode, complete the calculation of the data or immediate data read from the register;

MEM stage: Write data into the data memory according to the results obtained in the EX stage. Or read the data in the data memory according to the address calculated in the EX stage. Or pass the calculation result directly to the WB stage;

WB stage: write the result of the operation or the data read from the data memory to the register;
