---
layout: post
title:  "TDOA System"
info: "A system to estimate angle of far field sound source based on TDOA, served in a locator or tracker."
tech : "Python"
type: Project
---
<h2><center>A system to estimate angle of far field sound source based on TDOA</center></h2>

Click here to see the [code](https://github.com/MTZHANG1999/System-to-estimate-angle-of-far-field-sound-source).

## Ⅰ. Integrated solution

1. Analyze the original audio to prepare for pre-processing before training;
2. Select the frequency range of human voice, directly filter out the high frequency and low frequency noise outside the range;  
3. The noise spectrum in the passband is analyzed and further eliminated in the recording;
4. The TDOA algorithm was used to calculate the correlation coefficient and the microphones were grouped;
5. The angles obtained are synthesized to obtain the estimated angles.

## Ⅱ. Design ideas

### Bandpass filter selection and tuning

In addition to the human voice, the audio in the training set has a large amount of noise and a wide frequency range. Therefore, it is not good to be directly used for training and needs to be preprocessed.  The picture shows the spectrum of audio samples randomly selected in the training set.

![image-20201204151038794](/imgs/Projects/image-20201204151038794.png)

Firstly, for the audio in the training set, the linear and logarithmic frequency power spectrum is observed, and the frequency range of human voice is roughly determined within $$200 \sim 3000Hz$$. Therefore, the `butter` filter in `Librosa` can be directly used for band-pass filtering to remove part of the bottom noise.

![image-20201204151201996](/imgs/Projects/image-20201204151201996.png)

Using STFT spectrum to find Mel spectrum can be more clearly to see the frequency characteristics of audio

![image-20201204160702901](/imgs/Projects/image-20201204160702901.png)

### In-band noise reduction

After obtaining audio in a given frequency range, further noise reduction is required. The noise range of the audio in the initial period can be roughly obtained from the Mel spectrum obtained by the operation of frame segmentation, windowing, and DFT transformation of each frame. After calculating the noise spectrum, the noise can be further eliminated from the original audio.  

Several noise samples of the training set were selected and tuned by a bandpass filter. It can be seen from the Mel spectrum in the previous part that the part circled by the green wire is the initial noise fragment. The noise duration is about $$0.15 \sim 0.25s$$ according to the spectral image.  At the $$20000Hz$$ sampling rate, $$3000 \sim 5000$$ noise points are collected accordingly. To avoid voice acquisition due to different start times of different data, $$3000 \sim 4000$$ noise point samples are selected to further test its effect. 

### Upsampling

Re-sampling and re-squantization can minimize the influence of algorithm accuracy error on original audio. The audio in the training set is up-sampled，Theoretically, the higher the sampling rate, the more accurate the estimation result.

### Calculation principle and formula of correlation coefficient

TDOA is obtained by inverse Fourier transform of the correlation function. The specific realization formula is as follows:

$$
G(\omega)=X_1(\omega) {X_2}^*(\omega)\\
R(\tau)=\mathcal{F^{-1}}\{G(\omega)\}\\
\hat {\tau} = \arg \max _{\tau} R(\tau)
$$

### Angle estimation

The problem to be solved is that when the sound source is on the line of two microphones(the calculation Angle is close to $$0$$ degree), due to the precision problem of floating-point calculation, the resulting error may be large and the calculated value of cosine may be slightly greater than $$1$$. Since we have four microphones, we can solve this problem through Angle synthesis.

We first divided the microphone pairs of the diagonal lines into a group, calculated the angles respectively, and obtained two Angle data.  Next, determine which data falls within the best calculation range of microphones(that is, the direction of the sound source is closer to its vertical bisector), and then give the final result based on the data of the judged microphone pair.  The other pair of microphones only provides positive and negative information of Angle at this time. 



## Ⅲ. Experimental results and analysis

### Results

The error of the training set is quantified as $$\bar e=0.541^{\circ}$$ when the up-sampling multiple is $$15$$ and the initial sampling points are $$4000$$ as noise samples. The error of the training set is quantified as $$\bar e=0.393^{\circ}$$ under the premise that the up-sampling multiple is $$30$$ and the initial sampling points are $$4000$$ as noise samples. The error of the training set is quantified as $$\bar e=0.402^{\circ}$$ under the premise that the up-sampling multiple is $$20$$ and the initial sampling points are $$4000$$ as noise samples.  

### Analysis

- The higher the sampling multiple is, the smaller the mean error on the training set is. The actual experiment finds that the error is smaller when the noise sample is set at $$4000$$ sampling points.  The default up-sampling multiple is $$15$$, which can be adjusted according to the calculation performance.  
- Because the accuracy of floating-point calculation may lead to a large error and the calculated value of cosine may be slightly greater than $$1$$, the Angle synthesis method is used to solve the problem in the experiment.
- In addition, the nonlinear mapping design of cosine value can further reduce the error when the Angle is more parallel to the microphone. The algorithm can be further improved by a more accurate estimation of noise.